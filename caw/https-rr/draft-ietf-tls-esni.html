<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>TLS Encrypted Client Hello</title>
<meta content="Eric Rescorla" name="author">
<meta content="Kazuho Oku" name="author">
<meta content="Nick Sullivan" name="author">
<meta content="Christopher A. Wood" name="author">
<meta content="
       This document describes a mechanism in Transport Layer Security (TLS)
for encrypting a ClientHello message under a server public key. 
    " name="description">
<meta content="xml2rfc 2.45.3" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-ietf-tls-esni-latest" name="ietf.draft">
<link href="draft-ietf-tls-esni.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@import url('https://martinthomson.github.io/i-d-template/fonts.css');

html {
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --small-font-size: 14.5px;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
#title {
  padding: 1em 0 0.2em;
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1, h2, h3 {
  font-size: 22px;
  line-height: 26px;
}
h4, h5, h6 {
  font-size: 18px;
  line-height: 22px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p, #abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 18px;
  line-height: 24px;
}
p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
dd.break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href].selfRef {
  color: var(--text-color);
}
a[href] {
  color: var(--link-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px 'Oxygen Mono', monospace;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  pre {
    display: inline-block;
    overflow-x: auto;
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  pre + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
  table {
    display: inline-block;
    overflow-x: auto;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  text-align: left;
  background-color: #eee;
}
tr:nth-child(2n) > td {
  background-color: var(--background-color);
}
tr:nth-child(2n+1) > td {
  background-color: var(--highlight-color);
}
thead+tbody > tr:nth-child(2n) > td {
  background-color: var(--highlight-color);
}
thead+tbody > tr:nth-child(2n+1) > td {
  background-color: var(--background-color);
}
table caption {
  margin: 0;
  padding: 3px 1em;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  visibility: hidden;
  user-select: none;
}
a.pilcrow[href] { color: #ddd; }
a.pilcrow[href]:hover { text-decoration: none; }
@media screen {
  :hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 8em;
}
#identifiers dt {
  width: var(--identifier-width);
  margin: 0;
  clear: left;
  float: left;
  text-align: right;
}
#identifiers dd {
  margin: 0 0 0 calc(1em + var(--identifier-width));
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 500px) {
  .index ul {
    column-count: 2;
    column-gap: 20px;
  }
  .index ul ul {
    column-count: 1;
    column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul p, #toc ul li {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table .text-left, table .text-left {
  text-align: left;
}
table .text-center, table .text-center {
  text-align: center;
}
table .text-right, table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  dd {
    page-break-before: avoid;
  }
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
</head>
<body>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">TLS Encrypted Client Hello</td>
<td class="right">June 2020</td>
</tr></thead>
<tfoot><tr>
<td class="left">Rescorla, et al.</td>
<td class="center">Expires 19 December 2020</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">tls</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-ietf-tls-esni-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2020-06-17" class="published">17 June 2020</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Experimental</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2020-12-19">19 December 2020</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">E. Rescorla</div>
<div class="org">RTFM, Inc.</div>
</div>
<div class="author">
      <div class="author-name">K. Oku</div>
<div class="org">Fastly</div>
</div>
<div class="author">
      <div class="author-name">N. Sullivan</div>
<div class="org">Cloudflare</div>
</div>
<div class="author">
      <div class="author-name">C.A. Wood</div>
<div class="org">Cloudflare</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">TLS Encrypted Client Hello</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes a mechanism in Transport Layer Security (TLS)
for encrypting a ClientHello message under a server public key.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 19 December 2020.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2020 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a><a href="#section-toc.1-1.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="xref">2</a>.  <a href="#name-conventions-and-definitions" class="xref">Conventions and Definitions</a><a href="#section-toc.1-1.2.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="xref">3</a>.  <a href="#name-overview" class="xref">Overview</a><a href="#section-toc.1-1.3.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="xref">3.1</a>.  <a href="#name-topologies" class="xref">Topologies</a><a href="#section-toc.1-1.3.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="xref">3.2</a>.  <a href="#name-encrypted-clienthello-ech" class="xref">Encrypted ClientHello (ECH)</a><a href="#section-toc.1-1.3.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-encrypted-clienthello-confi" class="xref">Encrypted ClientHello Configuration</a><a href="#section-toc.1-1.4.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-the-encrypted_client_hello-" class="xref">The "encrypted_client_hello" extension</a><a href="#section-toc.1-1.5.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-the-ech_nonce-extension" class="xref">The "ech_nonce" extension</a><a href="#section-toc.1-1.6.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="xref">6.1</a>.  <a href="#name-incorporating-outer-extensi" class="xref">Incorporating Outer Extensions</a><a href="#section-toc.1-1.6.2.1.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-client-behavior" class="xref">Client Behavior</a><a href="#section-toc.1-1.7.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1" class="xref">7.1</a>.  <a href="#name-sending-an-encrypted-client" class="xref">Sending an encrypted ClientHello</a><a href="#section-toc.1-1.7.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2" class="xref">7.2</a>.  <a href="#name-recommended-padding-scheme" class="xref">Recommended Padding Scheme</a><a href="#section-toc.1-1.7.2.2.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a href="#section-7.3" class="xref">7.3</a>.  <a href="#name-handling-the-server-respons" class="xref">Handling the server response</a><a href="#section-toc.1-1.7.2.3.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.7.2.3.2.1">
                    <p id="section-toc.1-1.7.2.3.2.1.1"><a href="#section-7.3.1" class="xref">7.3.1</a>.  <a href="#name-accepted-ech" class="xref">Accepted ECH</a><a href="#section-toc.1-1.7.2.3.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.7.2.3.2.2">
                    <p id="section-toc.1-1.7.2.3.2.2.1"><a href="#section-7.3.2" class="xref">7.3.2</a>.  <a href="#name-rejected-ech" class="xref">Rejected ECH</a><a href="#section-toc.1-1.7.2.3.2.2.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.7.2.3.2.3">
                    <p id="section-toc.1-1.7.2.3.2.3.1"><a href="#section-7.3.3" class="xref">7.3.3</a>.  <a href="#name-helloretryrequest" class="xref">HelloRetryRequest</a><a href="#section-toc.1-1.7.2.3.2.3.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.7.2.4">
                <p id="section-toc.1-1.7.2.4.1"><a href="#section-7.4" class="xref">7.4</a>.  <a href="#name-grease-extensions" class="xref">GREASE extensions</a><a href="#section-toc.1-1.7.2.4.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-client-facing-server-behavi" class="xref">Client-Facing Server Behavior</a><a href="#section-toc.1-1.8.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="xref">9</a>.  <a href="#name-compatibility-issues" class="xref">Compatibility Issues</a><a href="#section-toc.1-1.9.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1" class="xref">9.1</a>.  <a href="#name-misconfiguration-and-deploy" class="xref">Misconfiguration and Deployment Concerns</a><a href="#section-toc.1-1.9.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a href="#section-9.2" class="xref">9.2</a>.  <a href="#name-middleboxes" class="xref">Middleboxes</a><a href="#section-toc.1-1.9.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="xref">10</a>. <a href="#name-security-considerations" class="xref">Security Considerations</a><a href="#section-toc.1-1.10.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="xref">10.1</a>.  <a href="#name-why-is-cleartext-dns-ok" class="xref">Why is cleartext DNS OK?</a><a href="#section-toc.1-1.10.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="xref">10.2</a>.  <a href="#name-client-tracking" class="xref">Client Tracking</a><a href="#section-toc.1-1.10.2.2.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.3">
                <p id="section-toc.1-1.10.2.3.1"><a href="#section-10.3" class="xref">10.3</a>.  <a href="#name-optional-record-digests-and" class="xref">Optional Record Digests and Trial Decryption</a><a href="#section-toc.1-1.10.2.3.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.4">
                <p id="section-toc.1-1.10.2.4.1"><a href="#section-10.4" class="xref">10.4</a>.  <a href="#name-related-privacy-leaks" class="xref">Related Privacy Leaks</a><a href="#section-toc.1-1.10.2.4.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5">
                <p id="section-toc.1-1.10.2.5.1"><a href="#section-10.5" class="xref">10.5</a>.  <a href="#name-comparison-against-criteria" class="xref">Comparison Against Criteria</a><a href="#section-toc.1-1.10.2.5.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5.2.1">
                    <p id="section-toc.1-1.10.2.5.2.1.1"><a href="#section-10.5.1" class="xref">10.5.1</a>.  <a href="#name-mitigate-against-replay-att" class="xref">Mitigate against replay attacks</a><a href="#section-toc.1-1.10.2.5.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5.2.2">
                    <p id="section-toc.1-1.10.2.5.2.2.1"><a href="#section-10.5.2" class="xref">10.5.2</a>.  <a href="#name-avoid-widely-deployed-share" class="xref">Avoid widely-deployed shared secrets</a><a href="#section-toc.1-1.10.2.5.2.2.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5.2.3">
                    <p id="section-toc.1-1.10.2.5.2.3.1"><a href="#section-10.5.3" class="xref">10.5.3</a>.  <a href="#name-prevent-sni-based-dos-attac" class="xref">Prevent SNI-based DoS attacks</a><a href="#section-toc.1-1.10.2.5.2.3.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5.2.4">
                    <p id="section-toc.1-1.10.2.5.2.4.1"><a href="#section-10.5.4" class="xref">10.5.4</a>.  <a href="#name-do-not-stick-out" class="xref">Do not stick out</a><a href="#section-toc.1-1.10.2.5.2.4.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5.2.5">
                    <p id="section-toc.1-1.10.2.5.2.5.1"><a href="#section-10.5.5" class="xref">10.5.5</a>.  <a href="#name-forward-secrecy" class="xref">Forward secrecy</a><a href="#section-toc.1-1.10.2.5.2.5.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5.2.6">
                    <p id="section-toc.1-1.10.2.5.2.6.1"><a href="#section-10.5.6" class="xref">10.5.6</a>.  <a href="#name-proper-security-context" class="xref">Proper security context</a><a href="#section-toc.1-1.10.2.5.2.6.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5.2.7">
                    <p id="section-toc.1-1.10.2.5.2.7.1"><a href="#section-10.5.7" class="xref">10.5.7</a>.  <a href="#name-split-server-spoofing" class="xref">Split server spoofing</a><a href="#section-toc.1-1.10.2.5.2.7.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.5.2.8">
                    <p id="section-toc.1-1.10.2.5.2.8.1"><a href="#section-10.5.8" class="xref">10.5.8</a>.  <a href="#name-supporting-multiple-protoco" class="xref">Supporting multiple protocols</a><a href="#section-toc.1-1.10.2.5.2.8.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.6">
                <p id="section-toc.1-1.10.2.6.1"><a href="#section-10.6" class="xref">10.6</a>.  <a href="#name-padding-policy" class="xref">Padding Policy</a><a href="#section-toc.1-1.10.2.6.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.7">
                <p id="section-toc.1-1.10.2.7.1"><a href="#section-10.7" class="xref">10.7</a>.  <a href="#name-active-attack-mitigations" class="xref">Active Attack Mitigations</a><a href="#section-toc.1-1.10.2.7.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.7.2.1">
                    <p id="section-toc.1-1.10.2.7.2.1.1"><a href="#section-10.7.1" class="xref">10.7.1</a>.  <a href="#name-client-reaction-attack-miti" class="xref">Client Reaction Attack Mitigation</a><a href="#section-toc.1-1.10.2.7.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.7.2.2">
                    <p id="section-toc.1-1.10.2.7.2.2.1"><a href="#section-10.7.2" class="xref">10.7.2</a>.  <a href="#name-helloretryrequest-hijack-mi" class="xref">HelloRetryRequest Hijack Mitigation</a><a href="#section-toc.1-1.10.2.7.2.2.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.10.2.7.2.3">
                    <p id="section-toc.1-1.10.2.7.2.3.1"><a href="#section-10.7.3" class="xref">10.7.3</a>.  <a href="#name-resumption-psk-oracle-mitig" class="xref">Resumption PSK Oracle Mitigation</a><a href="#section-toc.1-1.10.2.7.2.3.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="xref">11</a>. <a href="#name-iana-considerations" class="xref">IANA Considerations</a><a href="#section-toc.1-1.11.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-11.1" class="xref">11.1</a>.  <a href="#name-update-of-the-tls-extension" class="xref">Update of the TLS ExtensionType Registry</a><a href="#section-toc.1-1.11.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a href="#section-11.2" class="xref">11.2</a>.  <a href="#name-update-of-the-tls-alert-reg" class="xref">Update of the TLS Alert Registry</a><a href="#section-toc.1-1.11.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="xref">12</a>. <a href="#name-echconfig-extension-guidanc" class="xref">ECHConfig Extension Guidance</a><a href="#section-toc.1-1.12.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="xref">13</a>. <a href="#name-references" class="xref">References</a><a href="#section-toc.1-1.13.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.13.2.1">
                <p id="section-toc.1-1.13.2.1.1"><a href="#section-13.1" class="xref">13.1</a>.  <a href="#name-normative-references" class="xref">Normative References</a><a href="#section-toc.1-1.13.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.13.2.2">
                <p id="section-toc.1-1.13.2.2.1"><a href="#section-13.2" class="xref">13.2</a>.  <a href="#name-informative-references" class="xref">Informative References</a><a href="#section-toc.1-1.13.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-appendix.a" class="xref">Appendix A</a>.  <a href="#name-alternative-sni-protection-" class="xref">Alternative SNI Protection Designs</a><a href="#section-toc.1-1.14.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.14.2.1">
                <p id="section-toc.1-1.14.2.1.1"><a href="#section-a.1" class="xref">A.1</a>.  <a href="#name-tls-layer" class="xref">TLS-layer</a><a href="#section-toc.1-1.14.2.1.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.14.2.1.2.1">
                    <p id="section-toc.1-1.14.2.1.2.1.1"><a href="#section-a.1.1" class="xref">A.1.1</a>.  <a href="#name-tls-in-early-data" class="xref">TLS in Early Data</a><a href="#section-toc.1-1.14.2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.14.2.1.2.2">
                    <p id="section-toc.1-1.14.2.1.2.2.1"><a href="#section-a.1.2" class="xref">A.1.2</a>.  <a href="#name-combined-tickets" class="xref">Combined Tickets</a><a href="#section-toc.1-1.14.2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.14.2.2">
                <p id="section-toc.1-1.14.2.2.1"><a href="#section-a.2" class="xref">A.2</a>.  <a href="#name-application-layer" class="xref">Application-layer</a><a href="#section-toc.1-1.14.2.2.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty toc compact">
<li class="ulEmpty toc compact" id="section-toc.1-1.14.2.2.2.1">
                    <p id="section-toc.1-1.14.2.2.2.1.1"><a href="#section-a.2.1" class="xref">A.2.1</a>.  <a href="#name-http-2-certificate-frames" class="xref">HTTP/2 CERTIFICATE Frames</a><a href="#section-toc.1-1.14.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
</ul>
</li>
</ul>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-appendix.b" class="xref">Appendix B</a>.  <a href="#name-total-client-hello-encrypti" class="xref">Total Client Hello Encryption</a><a href="#section-toc.1-1.15.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#section-appendix.c" class="xref">Appendix C</a>.  <a href="#name-acknowledgements" class="xref">Acknowledgements</a><a href="#section-toc.1-1.16.1" class="pilcrow">¶</a></p>
</li>
<li class="ulEmpty toc compact" id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#section-appendix.d" class="xref"></a><a href="#name-authors-addresses" class="xref">Authors' Addresses</a><a href="#section-toc.1-1.17.1" class="pilcrow">¶</a></p>
</li>
</ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">DISCLAIMER: This is very early a work-in-progress design and has not
yet seen significant (or really any) security analysis. It should not
be used as a basis for building production systems.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">Although TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span> encrypts most of the handshake, including the
server certificate, there are several ways in which an on-path attacker can
learn private information about the connection. The cleartext Server Name Indication
(SNI) extension in ClientHello messages, which leaks the target domain for a given
connection, is perhaps the most sensitive information unencrypted in TLS 1.3.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">The target domain may also be visible through other channels, such as cleartext
client DNS queries, visible server IP addresses (assuming the server does not
use domain-based virtual hosting), or other indirect mechanisms such as traffic analysis.
DoH <span>[<a href="#I-D.ietf-doh-dns-over-https" class="xref">I-D.ietf-doh-dns-over-https</a>]</span> and DPRIVE <span>[<a href="#RFC7858" class="xref">RFC7858</a>]</span> <span>[<a href="#RFC8094" class="xref">RFC8094</a>]</span>
provide mechanisms for clients to conceal DNS lookups from network inspection,
and many TLS servers host multiple domains on the same IP address.
In such environments, the SNI remains the primary explicit signal used to
determine the server's identity.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">The TLS WG has extensively studied the problem of protecting the SNI, but
has been unable to develop a completely generic solution.
<span>[<a href="#I-D.ietf-tls-sni-encryption" class="xref">I-D.ietf-tls-sni-encryption</a>]</span> provides a description
of the problem space and some of the proposed techniques. One of the
more difficult problems is "Do not stick out"
(<span>[<a href="#I-D.ietf-tls-sni-encryption" class="xref">I-D.ietf-tls-sni-encryption</a>]</span>, Section 3.4): if only sensitive or private
services use SNI encryption, then SNI encryption is a signal that
a client is going to such a service. For this reason, much recent work
has focused on concealing the fact that the SNI is being protected. Unfortunately,
the result often has undesirable performance consequences, incomplete
coverage, or both.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">The design in this document takes a different approach: it assumes
that private origins will co-locate with or hide behind a provider (CDN, application
server, etc.) which can protect SNIs for all of the domains it hosts. As a result,
SNI protection does not indicate that the client is attempting to reach a private
origin, but only that it is going to a particular service provider, which the observer
could already tell from the visible IP address.<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">The design in this document introduces a new extension, called Encrypted Client
Hello (ECH), which allows clients to encrypt the entirety of their ClientHello
to a supporting server. This protects the SNI and other potentially sensitive fields,
such as the ALPN list. This extension is only supported with (D)TLS 1.3 <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>
and newer versions of the protocol.<a href="#section-1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
"SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span>
when, and only when, they appear in all capitals, as shown here. All TLS notation
comes from <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, Section 3.<a href="#section-2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="overview">
<section id="section-3">
      <h2 id="name-overview">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-overview" class="section-name selfRef">Overview</a>
      </h2>
<p id="section-3-1">This document is designed to operate in one of two primary topologies
shown below, which we call "Shared Mode" and "Split Mode"<a href="#section-3-1" class="pilcrow">¶</a></p>
<div id="topologies">
<section id="section-3.1">
        <h3 id="name-topologies">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-topologies" class="section-name selfRef">Topologies</a>
        </h3>
<span id="name-shared-mode-topology"></span><div id="shared-mode">
<figure id="figure-1">
          <div class="artwork art-text alignLeft" id="section-3.1-1.1">
<pre>
                +---------------------+
                |                     |
                |   2001:DB8::1111    |
                |                     |
Client &lt;-----&gt;  | private.example.org |
                |                     |
                | public.example.com  |
                |                     |
                +---------------------+
                        Server
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-shared-mode-topology" class="selfRef">Shared Mode Topology</a>
          </figcaption></figure>
</div>
<p id="section-3.1-2">In Shared Mode, the provider is the origin server for all the domains
whose DNS records point to it and clients form a TLS connection directly
to that provider, which has access to the plaintext of the connection.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<span id="name-split-mode-topology"></span><div id="split-mode">
<figure id="figure-2">
          <div class="artwork art-text alignLeft" id="section-3.1-3.1">
<pre>
                +--------------------+       +---------------------+
                |                    |       |                     |
                |   2001:DB8::1111   |       |   2001:DB8::EEEE    |
Client &lt;------------------------------------&gt;|                     |
                | public.example.com |       | private.example.com |
                |                    |       |                     |
                +--------------------+       +---------------------+
                  Client-Facing Server            Backend Server
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-split-mode-topology" class="selfRef">Split Mode Topology</a>
          </figcaption></figure>
</div>
<p id="section-3.1-4">In Split Mode, the provider is <em>not</em> the origin server for private
domains. Rather the DNS records for private domains point to the provider,
and the provider's server relays the connection back to the
backend server, which is the true origin server. The provider does
not have access to the plaintext of the connection.<a href="#section-3.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encrypted-clienthello-ech">
<section id="section-3.2">
        <h3 id="name-encrypted-clienthello-ech">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-encrypted-clienthello-ech" class="section-name selfRef">Encrypted ClientHello (ECH)</a>
        </h3>
<p id="section-3.2-1">ECH works by encrypting the entire ClientHello, including
the SNI and any additional extensions such as ALPN.
This requires that each provider publish a public key and
metadata which is used for ClientHello encryption for all the domains for
which it serves directly or indirectly (via Split Mode). This document
defines the format of the SNI encryption public key and metadata,
referred to as an ECH configuration, and delegates DNS publication
details to <span>[<a href="#HTTPS-RR" class="xref">HTTPS-RR</a>]</span>, though other
delivery mechanisms are possible. In particular, if some of the
clients of a private server are applications rather than Web browsers,
those applications might have the public key and metadata
preconfigured.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">When a client wants to form a TLS connection to any of the domains
served by an ECH-supporting provider, it constructs a ClientHello in
the regular fashion containing the true SNI value (ClientHelloInner)
and then encrypts it using the public key for the provider.  It then
constructs a new ClientHello (ClientHelloOuter) with an innocuous SNI
(and potentially innocuous versions of other extensions such as ALPN
<span>[<a href="#RFC7301" class="xref">RFC7301</a>]</span>) and containing the encrypted ClientHelloInner as an
extension. It sends ClientHelloOuter to the server.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">Upon receiving ClientHelloOuter, the server can then decrypt
ClientHelloInner and either terminate the connection (in Shared Mode)
or forward it to the backend server (in Split Mode).<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<p id="section-3.2-4">Note that both ClientHelloInner and ClientHelloOuter are both valid, complete
ClientHello messages. ClientHelloOuter carries an encrypted representation
of ClientHelloInner in a "encrypted_client_hello" extension, defined
in <a href="#encrypted-client-hello" class="xref">Section 5</a>.<a href="#section-3.2-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="ech-configuration">
<section id="section-4">
      <h2 id="name-encrypted-clienthello-confi">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-encrypted-clienthello-confi" class="section-name selfRef">Encrypted ClientHello Configuration</a>
      </h2>
<p id="section-4-1">ClientHello encryption configuration information is conveyed with the
following ECHConfigs structure.<a href="#section-4-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4-2">
<pre>
    opaque HpkePublicKey&lt;1..2^16-1&gt;;
    uint16 HkpeKemId;  // Defined in I-D.irtf-cfrg-hpke
    uint16 HkpeKdfId;  // Defined in I-D.irtf-cfrg-hpke
    uint16 HkpeAeadId; // Defined in I-D.irtf-cfrg-hpke

    struct {
        HkpeKdfId kdf_id;
        HkpeAeadId aead_id;
    } HpkeCipherSuite;

    struct {
        opaque public_name&lt;1..2^16-1&gt;;

        HpkePublicKey public_key;
        HkpeKemId kem_id;
        HpkeCipherSuite cipher_suites&lt;4..2^16-2&gt;;

        uint16 maximum_name_length;
        Extension extensions&lt;0..2^16-1&gt;;
    } ECHConfigContents;

    struct {
        uint16 version;
        uint16 length;
        select (ECHConfig.version) {
          case 0xff07: ECHConfigContents;
        }
    } ECHConfig;

    ECHConfig ECHConfigs&lt;1..2^16-1&gt;;
</pre><a href="#section-4-2" class="pilcrow">¶</a>
</div>
<p id="section-4-3">The ECHConfigs structure contains one or more ECHConfig structures in
decreasing order of preference. This allows a server to support multiple
versions of ECH and multiple sets of ECH parameters.<a href="#section-4-3" class="pilcrow">¶</a></p>
<p id="section-4-4">The ECHConfig structure contains the following fields:<a href="#section-4-4" class="pilcrow">¶</a></p>
<dl class="dlParallel" id="section-4-5">
        <dt id="section-4-5.1">version</dt>
<dd id="section-4-5.2">
  The version of the structure. For this specification, that value
SHALL be 0xff07. Clients MUST ignore any ECHConfig structure with a
version they do not understand.<a href="#section-4-5.2" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
<dt id="section-4-5.3">contents</dt>
<dd id="section-4-5.4">
  An opaque byte string whose contents depend on the version of the structure.
For this specification, the contents are an ECHConfigContents structure.<a href="#section-4-5.4" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
</dl>
<p id="section-4-6">The ECHConfigContents structure contains the following fields:<a href="#section-4-6" class="pilcrow">¶</a></p>
<dl class="dlParallel" id="section-4-7">
        <dt id="section-4-7.1">public_name</dt>
<dd id="section-4-7.2">
  The non-empty name of the entity trusted to update these encryption keys.
This is used to repair misconfigurations, as described in
<a href="#handle-server-response" class="xref">Section 7.3</a>.<a href="#section-4-7.2" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
<dt id="section-4-7.3">public_key</dt>
<dd id="section-4-7.4">
  The HPKE <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span> public key which can be used by the client to
encrypt the ClientHello.<a href="#section-4-7.4" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
<dt id="section-4-7.5">kem_id</dt>
<dd id="section-4-7.6">
  The HPKE <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span> KEM identifier corresponding to public_key.
Clients MUST ignore any ECHConfig structure with a key using a KEM they do not support.<a href="#section-4-7.6" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
<dt id="section-4-7.7">cipher_suites</dt>
<dd id="section-4-7.8">
  The list of HPKE <span>[<a href="#I-D.irtf-cfrg-hpke" class="xref">I-D.irtf-cfrg-hpke</a>]</span> AEAD and KDF identifier pairs clients can
use for encrypting the ClientHello.<a href="#section-4-7.8" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
<dt id="section-4-7.9">maximum_name_length</dt>
<dd id="section-4-7.10">
  The largest name the server expects to support, if known.
If this value is not known it can be set to zero, in which case clients SHOULD
use the inner ClientHello padding scheme described below.  That could happen if
wildcard names are in use, or if names can be added or removed from the
anonymity set during the lifetime of a particular resource record value.<a href="#section-4-7.10" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
<dt id="section-4-7.11">extensions</dt>
<dd id="section-4-7.12">
  A list of extensions that the client can take into consideration when
generating a ClientHello message. The purpose of the field is to provide room
for additional functionality in the future. See <a href="#config-extensions" class="xref">Section 12</a> for
guidance on what type of extensions are appropriate for this structure.<a href="#section-4-7.12" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
</dl>
<p id="section-4-8">The format is defined in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, Section 4.2. The same interpretation rules
apply: extensions MAY appear in any order, but there MUST NOT be more than one
extension of the same type in the extensions block. An extension can be tagged as
mandatory by using an extension type codepoint with the high order bit set to 1.
A client which receives a mandatory extension they do not understand MUST reject
the ECHConfig content.<a href="#section-4-8" class="pilcrow">¶</a></p>
<p id="section-4-9">Clients MUST parse the extension list and check for unsupported mandatory
extensions. If an unsupported mandatory extension is present, clients MUST
reject the ECHConfig value.<a href="#section-4-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="encrypted-client-hello">
<section id="section-5">
      <h2 id="name-the-encrypted_client_hello-">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-the-encrypted_client_hello-" class="section-name selfRef">The "encrypted_client_hello" extension</a>
      </h2>
<p id="section-5-1">The encrypted ClientHelloInner is carried in an "encrypted_client_hello"
extension, defined as follows:<a href="#section-5-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-2">
<pre>
   enum {
       encrypted_client_hello(0xff02), (65535)
   } ExtensionType;
</pre><a href="#section-5-2" class="pilcrow">¶</a>
</div>
<p id="section-5-3">For clients (in ClientHello), this extension contains the following
ClientEncryptedCH structure:<a href="#section-5-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-4">
<pre>
   struct {
       HpkeCipherSuite suite;
       opaque record_digest&lt;0..2^16-1&gt;;
       opaque enc&lt;1..2^16-1&gt;;
       opaque encrypted_ch&lt;1..2^16-1&gt;;
   } ClientEncryptedCH;
</pre><a href="#section-5-4" class="pilcrow">¶</a>
</div>
<dl class="dlParallel" id="section-5-5">
        <dt id="section-5-5.1">suite</dt>
<dd id="section-5-5.2">
  The HpkeCipherSuite cipher suite used to encrypt ClientHelloInner. This MUST
match a value provided in the corresponding ECHConfig.cipher_suites list.<a href="#section-5-5.2" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
<dt id="section-5-5.3">record_digest</dt>
<dd id="section-5-5.4">
  A cryptographic hash of the ECHConfig structure from which the ECH
key was obtained, i.e., from the first byte of "version" to the end
of the structure.  This hash is computed using the hash function
associated with <code>suite</code>, i.e., the corresponding HPKE KDF algorithm hash.<a href="#section-5-5.4" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
<dt id="section-5-5.5">enc</dt>
<dd id="section-5-5.6">
  The HPKE encapsulated key, used by servers to decrypt the corresponding
encrypted_ch field.<a href="#section-5-5.6" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
<dt id="section-5-5.7">encrypted_ch</dt>
<dd id="section-5-5.8">
  The serialized and encrypted ClientHelloInner structure, AEAD-encrypted using
HPKE with the selected KEM, KDF, and AEAD algorithm and key generated as described below.<a href="#section-5-5.8" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
</dl>
<p id="section-5-6">If the server accepts ECH, it does not send this extension.
If it rejects ECH, then it sends the following structure in
EncryptedExtensions:<a href="#section-5-6" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-5-7">
<pre>
   struct {
       ECHConfigs retry_configs;
   } ServerEncryptedCH;
</pre><a href="#section-5-7" class="pilcrow">¶</a>
</div>
<dl class="dlParallel" id="section-5-8">
        <dt id="section-5-8.1">retry_configs</dt>
<dd id="section-5-8.2">
  An ECHConfigs structure containing one or more ECHConfig structures in
decreasing order of preference that the client should use on subsequent
connections to encrypt the ClientHelloInner structure.<a href="#section-5-8.2" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
</dl>
<p id="section-5-9">This protocol also defines the "ech_required" alert, which is sent by the
client when it offered an "encrypted_client_hello" extension which was not
accepted by the server.<a href="#section-5-9" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ech-nonce">
<section id="section-6">
      <h2 id="name-the-ech_nonce-extension">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-the-ech_nonce-extension" class="section-name selfRef">The "ech_nonce" extension</a>
      </h2>
<p id="section-6-1">When using ECH, the client MUST also add an extension of type
"ech_nonce" to the ClientHelloInner (but not to the outer
ClientHello). This nonce ensures that the server's encrypted
Certificate can only be read by the entity which sent this
ClientHello. This extension is defined as follows:<a href="#section-6-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-6-2">
<pre>
   enum {
       ech_nonce(0xff03), (65535)
   } ExtensionType;

   struct {
       uint8 nonce[16];
   } ECHNonce;
</pre><a href="#section-6-2" class="pilcrow">¶</a>
</div>
<dl class="dlParallel" id="section-6-3">
        <dt id="section-6-3.1">nonce</dt>
<dd id="section-6-3.2">
  A 16-byte nonce exported from the HPKE encryption context. See <a href="#send-ech" class="xref">Section 7.1</a>
for details about its computation.<a href="#section-6-3.2" class="pilcrow">¶</a>
</dd>
<dd class="break"></dd>
</dl>
<p id="section-6-4">Finally, requirements in <a href="#client-behavior" class="xref">Section 7</a> and <a href="#server-behavior" class="xref">Section 8</a> require
implementations to track, alongside each PSK established by a previous
connection, whether the connection negotiated this extension with the
"ech_accept" response type. If so, this is referred to as an "ECH PSK".
Otherwise, it is a "non-ECH PSK". This may be implemented by adding a new field
to client and server session states.<a href="#section-6-4" class="pilcrow">¶</a></p>
<div id="outer-extensions">
<section id="section-6.1">
        <h3 id="name-incorporating-outer-extensi">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-incorporating-outer-extensi" class="section-name selfRef">Incorporating Outer Extensions</a>
        </h3>
<p id="section-6.1-1">Some TLS 1.3 extensions can be quite large
and having them both in the inner and outer ClientHello will lead to
a very large overall size. One particularly pathological example
is "key_share" with post-quantum algorithms. In order to reduce
the impact of duplicated extensions, the client may use the
"outer_extensions" extension.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-6.1-2">
<pre>
   enum {
       outer_extension(0xff04), (65535)
   } ExtensionType;

   struct {
       ExtensionType outer_extensions&lt;2..254&gt;;
       uint8 hash&lt;32..255&gt;;
   } OuterExtensions;
</pre><a href="#section-6.1-2" class="pilcrow">¶</a>
</div>
<p id="section-6.1-3">OuterExtensions MUST only be used in ClientHelloInner. It consists
of one or more ExtensionType values, each of which reference an
extension in ClientHelloOuter, and a digest of the complete
ClientHelloInner.<a href="#section-6.1-3" class="pilcrow">¶</a></p>
<p id="section-6.1-4">When sending ClientHello, the client first computes ClientHelloInner,
including any PSK binders, and then MAY substitute extensions which
it knows will be duplicated in ClientHelloOuter. To do so, the client
computes a hash H of the entire ClientHelloInner message with the same
hash as for the KDF used to encrypt ClientHelloInner. Then, the client
removes and and replaces extensions from ClientHelloInner with a single
"outer_extensions" extension. The list of outer_extensions include those
which were removed from ClientHelloInner, in the order in which they were
removed. The hash contains the full ClientHelloInner hash H computed above.<a href="#section-6.1-4" class="pilcrow">¶</a></p>
<p id="section-6.1-5">This process is reversed by client-facing servers upon receipt. Specifically,
the server replaces the "outer_extensions" with extensions contained in
ClientHelloOuter. The server then computes a hash H' of the reconstructed
ClientHelloInner. If H' does not equal OuterExtensions.hash, the server aborts
the connection with an "illegal_parameter" alert.<a href="#section-6.1-5" class="pilcrow">¶</a></p>
<p id="section-6.1-6">Clients SHOULD only use this mechanism for extensions which are
large. All other extensions SHOULD appear in both ClientHelloInner
and ClientHelloOuter even if they have identical values.<a href="#section-6.1-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="client-behavior">
<section id="section-7">
      <h2 id="name-client-behavior">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-client-behavior" class="section-name selfRef">Client Behavior</a>
      </h2>
<div id="send-ech">
<section id="section-7.1">
        <h3 id="name-sending-an-encrypted-client">
<a href="#section-7.1" class="section-number selfRef">7.1. </a><a href="#name-sending-an-encrypted-client" class="section-name selfRef">Sending an encrypted ClientHello</a>
        </h3>
<p id="section-7.1-1">In order to send an encrypted ClientHello, the client first determines if it
supports the server's chosen KEM, as identified by ECHConfig.kem_id. If one
is supported, the client MUST select an appropriate HpkeCipherSuite from the list of
suites offered by the server. If the client does not support the corresponding
KEM or is unable to select an appropriate group or HpkeCipherSuite, it SHOULD ignore
that ECHConfig value and MAY attempt to use another value provided by
the server. The client MUST NOT send ECH using HPKE algorithms not advertised
by the server.<a href="#section-7.1-1" class="pilcrow">¶</a></p>
<p id="section-7.1-2">Given a compatible ECHConfig with fields public_key and kem_id, carrying the HpkePublicKey
and KEM identifier corresponding to the server, clients compute an HPKE encryption
context as follows:<a href="#section-7.1-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.1-3">
<pre>
pkR = HPKE.KEM.Unmarshal(ECHConfig.public_key)
enc, context = SetupBaseS(pkR, "tls13-ech")
ech_nonce_value = context.Export("tls13-ech-nonce", 16)
ech_hrr_key = context.Export("tls13-ech-hrr-key", 16)
</pre><a href="#section-7.1-3" class="pilcrow">¶</a>
</div>
<p id="section-7.1-4">Note that the HPKE algorithm identifiers are those which match the client's
chosen preference from ECHConfig.cipher_suites. The client MAY replace any large,
duplicated extensions in ClientHelloInner with the corresponding "outer_extensions"
extension, as described in <a href="#outer-extensions" class="xref">Section 6.1</a>.<a href="#section-7.1-4" class="pilcrow">¶</a></p>
<p id="section-7.1-5">The client then generates a ClientHelloInner value. In addition to the normal
values, ClientHelloInner MUST also contain:<a href="#section-7.1-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.1-6.1">an "ech_nonce" extension, containing <code>ech_nonce_value</code> derived above<a href="#section-7.1-6.1" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-7.1-6.2">TLS padding <span>[<a href="#RFC7685" class="xref">RFC7685</a>]</span> (see <a href="#padding" class="xref">Section 7.2</a>)<a href="#section-7.1-6.2" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-7.1-7">When offering an encrypted ClientHello, the client MUST NOT offer to resume any
non-ECH PSKs. It additionally MUST NOT offer to resume any sessions for TLS 1.2
or below.<a href="#section-7.1-7" class="pilcrow">¶</a></p>
<p id="section-7.1-8">The encrypted ClientHello value is then computed as:<a href="#section-7.1-8" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.1-9">
<pre>
    encrypted_ch = context.Seal("", ClientHelloInner)
</pre><a href="#section-7.1-9" class="pilcrow">¶</a>
</div>
<p id="section-7.1-10">Finally, the client MUST generate a ClientHelloOuter message
containing the "encrypted_client_hello" extension with the values as
indicated above. In particular,<a href="#section-7.1-10" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.1-11.1">suite contains the client's chosen HpkeCipherSuite;<a href="#section-7.1-11.1" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-7.1-11.2">record_digest contains the digest of the corresponding ECHConfig structure;<a href="#section-7.1-11.2" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-7.1-11.3">enc contains the encapsulated key as output by SetupBaseS; and<a href="#section-7.1-11.3" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-7.1-11.4">encrypted_ch contains the HPKE encapsulated key (enc) and the ClientHelloInner
ciphertext (encrypted_ch_inner).<a href="#section-7.1-11.4" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-7.1-12">The client MUST place the value of ECHConfig.public_name in the
ClientHelloOuter "server_name" extension. The ClientHelloOuter MUST NOT
contain a "cached_info" extension <span>[<a href="#RFC7924" class="xref">RFC7924</a>]</span> with a CachedObject
entry whose CachedInformationType is "cert", since this indication
would divulge the true server name. The remaining
contents of the ClientHelloOuter MAY be identical to those in
ClientHelloInner but MAY also differ.<a href="#section-7.1-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="padding">
<section id="section-7.2">
        <h3 id="name-recommended-padding-scheme">
<a href="#section-7.2" class="section-number selfRef">7.2. </a><a href="#name-recommended-padding-scheme" class="section-name selfRef">Recommended Padding Scheme</a>
        </h3>
<p id="section-7.2-1">This section describes a deterministic padding mechanism based on the following
observation: individual extensions can reveal sensitive information through their
length. Thus, each extension in the inner ClientHello may require different amounts
of padding. This padding may be fully determined by the client's configuration or
may require server input.<a href="#section-7.2-1" class="pilcrow">¶</a></p>
<p id="section-7.2-2">By way of example, clients typically support a small number of application profiles.
For instance, a browser might support HTTP with ALPN values ["http/1.1, "h2"] and
WebRTC media with ALPNs ["webrtc", "c-webrtc"]. Clients SHOULD pad this extension by
rounding up to the total size of the longest ALPN extension across all application
profiles. The target padding length of most ClientHello extensions can be computed
in this way.<a href="#section-7.2-2" class="pilcrow">¶</a></p>
<p id="section-7.2-3">In contrast, clients do not know the longest SNI value in the client-facing server's
anonymity set without server input. For the "server_name" extension with length D,
clients SHOULD use the server's length hint L (ECHCOnfig.maximum_name_length) when
computing the padding as follows:<a href="#section-7.2-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-7.2-4">
          <li id="section-7.2-4.1">If L &gt; D, add L - D bytes of padding. This rounds to the server's advertised
hint, i.e., ECHConfig.maximum_name_length.<a href="#section-7.2-4.1" class="pilcrow">¶</a>
</li>
<li id="section-7.2-4.2">Otherwise, add 32 - (D % 32) bytes of padding. This rounds D up to the nearest
multiple of 32 bytes.<a href="#section-7.2-4.2" class="pilcrow">¶</a>
</li>
</ol>
<p id="section-7.2-5">In addition to padding ClientHelloInner, clients and servers will also need
to pad all other handshake messages that have sensitive-length fields. For
example, if a client proposes ALPN values in ClientHelloInner, the
server-selected value will be returned in an EncryptedExtension, so that
handshake message also needs to be padded using TLS record layer padding.<a href="#section-7.2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="handle-server-response">
<section id="section-7.3">
        <h3 id="name-handling-the-server-respons">
<a href="#section-7.3" class="section-number selfRef">7.3. </a><a href="#name-handling-the-server-respons" class="section-name selfRef">Handling the server response</a>
        </h3>
<p id="section-7.3-1">As described in <a href="#server-behavior" class="xref">Section 8</a>, the server MAY either accept ECH
and use ClientHelloInner or reject it and use ClientHelloOuter. However,
there is no indication in ServerHello of which one the server has done
and the client must therefore use trial decryption in order to determine
this.<a href="#section-7.3-1" class="pilcrow">¶</a></p>
<div id="accepted-ech">
<section id="section-7.3.1">
          <h4 id="name-accepted-ech">
<a href="#section-7.3.1" class="section-number selfRef">7.3.1. </a><a href="#name-accepted-ech" class="section-name selfRef">Accepted ECH</a>
          </h4>
<p id="section-7.3.1-1">If the server used ClientHelloInner, the client proceeds with the
connection as usual, authenticating the connection for the origin
server.<a href="#section-7.3.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="rejected-ech">
<section id="section-7.3.2">
          <h4 id="name-rejected-ech">
<a href="#section-7.3.2" class="section-number selfRef">7.3.2. </a><a href="#name-rejected-ech" class="section-name selfRef">Rejected ECH</a>
          </h4>
<p id="section-7.3.2-1">If the server used ClientHelloOuter, the client proceeds with the handshake,
authenticating for ECHConfig.public_name as described in
<a href="#auth-public-name" class="xref">Section 7.3.2.1</a>. If authentication or the handshake fails, the client
MUST return a failure to the calling application. It MUST NOT use the retry
keys.<a href="#section-7.3.2-1" class="pilcrow">¶</a></p>
<p id="section-7.3.2-2">Otherwise, when the handshake completes successfully with the public name
authenticated, the client MUST abort the connection with an "ech_required"
alert. It then processes the "retry_keys" field from the server's
"encrypted_client_hello" extension.<a href="#section-7.3.2-2" class="pilcrow">¶</a></p>
<p id="section-7.3.2-3">If one of the values contains a version supported by the client, it can regard
the ECH keys as securely replaced by the server. It SHOULD retry the
handshake with a new transport connection, using that value to encrypt the
ClientHello. The value may only be applied to the retry connection. The client
MUST continue to use the previously-advertised keys for subsequent
connections. This avoids introducing pinning concerns or a tracking vector,
should a malicious server present client-specific retry keys to identify
clients.<a href="#section-7.3.2-3" class="pilcrow">¶</a></p>
<p id="section-7.3.2-4">If none of the values provided in "retry_keys" contains a supported version,
the client can regard ECH as securely disabled by the server. As below, it
SHOULD then retry the handshake with a new transport connection and ECH
disabled.<a href="#section-7.3.2-4" class="pilcrow">¶</a></p>
<p id="section-7.3.2-5">If the field contains any other value, the client MUST abort the connection
with an "illegal_parameter" alert.<a href="#section-7.3.2-5" class="pilcrow">¶</a></p>
<p id="section-7.3.2-6">If the server negotiates an earlier version of TLS, or if it does not
provide an "encrypted_client_hello" extension in EncryptedExtensions, the
client proceeds with the handshake, authenticating for
ECHConfigContents.public_name as described in <a href="#auth-public-name" class="xref">Section 7.3.2.1</a>. If an earlier
version was negotiated, the client MUST NOT enable the False Start optimization
<span>[<a href="#RFC7918" class="xref">RFC7918</a>]</span> for this handshake. If authentication or the handshake fails, the
client MUST return a failure to the calling application. It MUST NOT treat this
as a secure signal to disable ECH.<a href="#section-7.3.2-6" class="pilcrow">¶</a></p>
<p id="section-7.3.2-7">Otherwise, when the handshake completes successfully with the public name
authenticated, the client MUST abort the connection with an "ech_required"
alert. The client can then regard ECH as securely disabled by the server. It
SHOULD retry the handshake with a new transport connection and ECH disabled.<a href="#section-7.3.2-7" class="pilcrow">¶</a></p>
<p id="section-7.3.2-8">Clients SHOULD implement a limit on retries caused by "ech_retry_request" or
servers which do not acknowledge the "encrypted_client_hello" extension. If the
client does not retry in either scenario, it MUST report an error to the
calling application.<a href="#section-7.3.2-8" class="pilcrow">¶</a></p>
<div id="auth-public-name">
<section id="section-7.3.2.1">
            <h5 id="name-authenticating-for-the-publ">
<a href="#section-7.3.2.1" class="section-number selfRef">7.3.2.1. </a><a href="#name-authenticating-for-the-publ" class="section-name selfRef">Authenticating for the public name</a>
            </h5>
<p id="section-7.3.2.1-1">When the server cannot decrypt or does not process the "encrypted_client_hello"
extension, it continues with the handshake using the cleartext "server_name"
extension instead (see <a href="#server-behavior" class="xref">Section 8</a>). Clients that offer ECH then
authenticate the connection with the public name, as follows:<a href="#section-7.3.2.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.3.2.1-2.1">If the server resumed a session or negotiated a session that did not use a
certificate for authentication, the client MUST abort the connection with an
"illegal_parameter" alert. This case is invalid because <a href="#send-ech" class="xref">Section 7.1</a> requires
the client to only offer ECH-established sessions, and <a href="#server-behavior" class="xref">Section 8</a>
requires the server to decline ECH-established sessions if it did not accept
ECH.<a href="#section-7.3.2.1-2.1" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-7.3.2.1-2.2">The client MUST verify that the certificate is valid for ECHConfigContents.public_name.
If invalid, it MUST abort the connection with the appropriate alert.<a href="#section-7.3.2.1-2.2" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-7.3.2.1-2.3">If the server requests a client certificate, the client MUST respond with an
empty Certificate message, denoting no client certificate.<a href="#section-7.3.2.1-2.3" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-7.3.2.1-3">Note that authenticating a connection for the public name does not authenticate
it for the origin. The TLS implementation MUST NOT report such connections as
successful to the application. It additionally MUST ignore all session tickets
and session IDs presented by the server. These connections are only used to
trigger retries, as described in <a href="#handle-server-response" class="xref">Section 7.3</a>. This may be
implemented, for instance, by reporting a failed connection with a dedicated
error code.<a href="#section-7.3.2.1-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="helloretryrequest">
<section id="section-7.3.3">
          <h4 id="name-helloretryrequest">
<a href="#section-7.3.3" class="section-number selfRef">7.3.3. </a><a href="#name-helloretryrequest" class="section-name selfRef">HelloRetryRequest</a>
          </h4>
<p id="section-7.3.3-1">If the server sends a HelloRetryRequest in response to the ClientHello,
the client sends a second updated ClientHello per the rules in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>.
However, at this point, the client does not know whether the server processed
ClientHelloOuter or ClientHelloInner, and MUST regenerate both values to
be acceptable. Note: if the inner and outer ClientHellos use different groups
for their key shares or differ in some other way, then the HelloRetryRequest may
actually be invalid for one or the other ClientHello, in which case a
fresh ClientHello MUST be generated, ignoring the instructions in HelloRetryRequest.
Otherwise, the usual rules for HelloRetryRequest processing apply.<a href="#section-7.3.3-1" class="pilcrow">¶</a></p>
<p id="section-7.3.3-2">Clients bind encryption of the second ClientHelloInner to encryption of the first
ClientHelloInner via the derived ech_hrr_key by modifying HPKE setup as follows:<a href="#section-7.3.3-2" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.3.3-3">
<pre>
pkR = HPKE.KEM.Unmarshal(ECHConfig.public_key)
enc, context = SetupPSKS(pkR, "tls13-ech-hrr", ech_hrr_key, "")
ech_nonce_value = context.Export("tls13-ech-hrr-nonce", 16)
</pre><a href="#section-7.3.3-3" class="pilcrow">¶</a>
</div>
<p id="section-7.3.3-4">Clients then encrypt the second ClientHelloInner using this new HPKE context.
In doing so, the encrypted value is also authenticated by ech_hrr_key. The rationale
for this is described in <a href="#flow-hrr-hijack" class="xref">Section 10.7.2</a>.<a href="#section-7.3.3-4" class="pilcrow">¶</a></p>
<p id="section-7.3.3-5">Client-facing servers perform the corresponding process when decrypting second
ClientHelloInner messages. In particular, upon receipt of a second ClientHello
message with a ClientEncryptedCH value, servers setup their HPKE context and
decrypt ClientEncryptedCH as follows:<a href="#section-7.3.3-5" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-7.3.3-6">
<pre>
context = SetupPSKR(ClientEncryptedCH.enc, skR, "tls13-ech-hrr", ech_hrr_key, "")
ClientHelloInner = context.Open("", ClientEncryptedCH.encrypted_ch)
ech_nonce_value = context.Export("tls13-ech-hrr-nonce", 16)
</pre><a href="#section-7.3.3-6" class="pilcrow">¶</a>
</div>
<p id="section-7.3.3-7">[[OPEN ISSUE: Should we be using the PSK input or the info input?
On the one hand, the requirements on info seem weaker, but maybe
actually this needs to be secret? Analysis needed.]]<a href="#section-7.3.3-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="grease-extensions">
<section id="section-7.4">
        <h3 id="name-grease-extensions">
<a href="#section-7.4" class="section-number selfRef">7.4. </a><a href="#name-grease-extensions" class="section-name selfRef">GREASE extensions</a>
        </h3>
<p id="section-7.4-1">If the client attempts to connect to a server and does not have an ECHConfig
structure available for the server, it SHOULD send a GREASE
<span>[<a href="#RFC8701" class="xref">RFC8701</a>]</span> "encrypted_client_hello" extension as follows:<a href="#section-7.4-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7.4-2.1">Set the "suite" field  to a supported HpkeCipherSuite. The selection
SHOULD vary to exercise all supported configurations, but MAY be held constant
for successive connections to the same server in the same session.<a href="#section-7.4-2.1" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-7.4-2.2">Set the "record_digest" field to a randomly-generated string of hash_length
bytes, where hash_length is the length of the hash function associated with
the chosen HpkeCipherSuite.<a href="#section-7.4-2.2" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-7.4-2.3">Set the "enc" field to a randomly-generated valid encapsulated public key
output by the HPKE KEM.<a href="#section-7.4-2.3" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-7.4-2.4">Set the "encrypted_ch" field to a randomly-generated string of L bytes, where
L is the size of the ClientHelloInner message the client would use given an
ECHConfig structure, padded according to <a href="#padding" class="xref">Section 7.2</a>.<a href="#section-7.4-2.4" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-7.4-3">If the server sends an "encrypted_client_hello" extension, the client
MUST check the extension syntactically and abort the connection with a
"decode_error" alert if it is invalid.<a href="#section-7.4-3" class="pilcrow">¶</a></p>
<p id="section-7.4-4">Offering a GREASE extension is not considered offering an encrypted ClientHello for
purposes of requirements in <a href="#client-behavior" class="xref">Section 7</a>. In particular, the client MAY
offer to resume sessions established without ECH.<a href="#section-7.4-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="server-behavior">
<section id="section-8">
      <h2 id="name-client-facing-server-behavi">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-client-facing-server-behavi" class="section-name selfRef">Client-Facing Server Behavior</a>
      </h2>
<p id="section-8-1">Upon receiving an "encrypted_client_hello" extension, the client-facing
server MUST check that it is able to negotiate TLS 1.3 or greater. If not,
it MUST abort the connection with a "handshake_failure" alert.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">The ClientEncryptedCH value is said to match a known ECHConfig if there exists
an ECHConfig that can be used to successfully decrypt ClientEncryptedCH.encrypted_ch.
This matching procedure should be done using one of the following two checks:<a href="#section-8-2" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-8-3">
        <li id="section-8-3.1">Compare ClientEncryptedCH.record_digest against cryptographic hashes of known ECHConfig
and choose the one that matches.<a href="#section-8-3.1" class="pilcrow">¶</a>
</li>
<li id="section-8-3.2">Use trial decryption of ClientEncryptedCH.encrypted_ch with known ECHConfig and choose
the one that succeeds.<a href="#section-8-3.2" class="pilcrow">¶</a>
</li>
</ol>
<p id="section-8-4">Some uses of ECH, such as local discovery mode, may omit the ClientEncryptedCH.record_digest
since it can be used as a tracking vector. In such cases, trial decryption should be
used for matching ClientEncryptedCH to known ECHConfig. Unless specified by the application
using (D)TLS or externally configured on both sides, implementations MUST use the first method.<a href="#section-8-4" class="pilcrow">¶</a></p>
<p id="section-8-5">If the ClientEncryptedCH value does not match any known ECHConfig
structure, it MUST ignore the extension and proceed with the connection,
with the following added behavior:<a href="#section-8-5" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-8-6.1">It MUST include the "encrypted_client_hello" extension with the
"retry_keys" field set to one or more ECHConfig structures with
up-to-date keys. Servers MAY supply multiple ECHConfig values of
different versions. This allows a server to support multiple
versions at once.<a href="#section-8-6.1" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-8-6.2">The server MUST ignore all PSK identities in the ClientHello which correspond
to ECH PSKs. ECH PSKs offered by the client are associated with the ECH
name. The server was unable to decrypt then ECH name, so it should not resume
them when using the cleartext SNI name. This restriction allows a client to
reject resumptions in <a href="#auth-public-name" class="xref">Section 7.3.2.1</a>.<a href="#section-8-6.2" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-8-7">Note that an unrecognized ClientEncryptedCH.record_digest value may be
a GREASE ECH extension (see <a href="#grease-extensions" class="xref">Section 7.4</a>), so it is necessary
for servers to proceed with the connection and rely on the client to abort if
ECH was required. In particular, the unrecognized value alone does not
indicate a misconfigured ECH advertisement (<a href="#misconfiguration" class="xref">Section 9.1</a>). Instead,
servers can measure occurrences of the "ech_required" alert to detect this
case.<a href="#section-8-7" class="pilcrow">¶</a></p>
<p id="section-8-8">If the ClientEncryptedCH value matches a known ECHConfig, the server
then decrypts ClientEncryptedCH.encrypted_ch, using the private key skR
corresponding to ECHConfig, as follows:<a href="#section-8-8" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-8-9">
<pre>
context = SetupBaseR(ClientEncryptedCH.enc, skR, "tls13-ech")
ClientHelloInner = context.Open("", ClientEncryptedCH.encrypted_ch)
ech_nonce_value = context.Export("tls13-ech-nonce", 16)
ech_hrr_key = context.Export("tls13-ech-hrr-key", 16)
</pre><a href="#section-8-9" class="pilcrow">¶</a>
</div>
<p id="section-8-10">If decryption fails, the server MUST abort the connection with
a "decrypt_error" alert. Moreover, if there is no "ech_nonce"
extension, or if its value does not match the derived ech_nonce,
the server MUST abort the connection with a "decrypt_error" alert.
Next, the server MUST scan ClientHelloInner for any "outer_extension"
extensions and substitute their values with the values in ClientHelloOuter.
It MUST first verify that the hash found in the extension matches the hash
of the extension to be interpolated in and if it does not, abort the connections
with a "decrypt_error" alert.<a href="#section-8-10" class="pilcrow">¶</a></p>
<p id="section-8-11">Upon determining the true SNI, the client-facing server then either
serves the connection directly (if in Shared Mode), in which case
it executes the steps in the following section, or forwards
the TLS connection to the backend server (if in Split Mode). In
the latter case, it does not make any changes to the TLS
messages, but just blindly forwards them.<a href="#section-8-11" class="pilcrow">¶</a></p>
<p id="section-8-12">If the server sends a NewSessionTicket message, the corresponding ECH PSK MUST
be ignored by all other servers in the deployment when not negotiating ECH,
including servers which do not implement this specification.<a href="#section-8-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="compatibility-issues">
<section id="section-9">
      <h2 id="name-compatibility-issues">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-compatibility-issues" class="section-name selfRef">Compatibility Issues</a>
      </h2>
<p id="section-9-1">Unlike most TLS extensions, placing the SNI value in an ECH extension
is not interoperable with existing servers, which expect the value in
the existing cleartext extension. Thus server operators SHOULD ensure
servers understand a given set of ECH keys before advertising them.
Additionally, servers SHOULD retain support for any
previously-advertised keys for the duration of their validity<a href="#section-9-1" class="pilcrow">¶</a></p>
<p id="section-9-2">However, in more complex deployment scenarios, this may be difficult
to fully guarantee. Thus this protocol was designed to be robust in case
of inconsistencies between systems that advertise ECH keys and servers, at the
cost of extra round-trips due to a retry. Two specific scenarios are detailed
below.<a href="#section-9-2" class="pilcrow">¶</a></p>
<div id="misconfiguration">
<section id="section-9.1">
        <h3 id="name-misconfiguration-and-deploy">
<a href="#section-9.1" class="section-number selfRef">9.1. </a><a href="#name-misconfiguration-and-deploy" class="section-name selfRef">Misconfiguration and Deployment Concerns</a>
        </h3>
<p id="section-9.1-1">It is possible for ECH advertisements and servers to become inconsistent. This
may occur, for instance, from DNS misconfiguration, caching issues, or an
incomplete rollout in a multi-server deployment. This may also occur if a server
loses its ECH keys, or if a deployment of ECH must be rolled back on the
server.<a href="#section-9.1-1" class="pilcrow">¶</a></p>
<p id="section-9.1-2">The retry mechanism repairs inconsistencies, provided the server is
authoritative for the public name. If server and advertised keys mismatch,
the server will respond with ech_retry_requested. If the server does not understand the
"encrypted_client_hello" extension at all, it will ignore it as required by <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>;
Section 4.1.2. Provided the server can present a certificate valid for the public name,
the client can safely retry with updated settings, as described in <a href="#handle-server-response" class="xref">Section 7.3</a>.<a href="#section-9.1-2" class="pilcrow">¶</a></p>
<p id="section-9.1-3">Unless ECH is disabled as a result of successfully establishing a connection to
the public name, the client MUST NOT fall back to using unencrypted ClientHellos, as this allows
a network attacker to disclose the contents of this ClientHello, including the SNI.
It MAY attempt to use another server from the DNS results, if one is provided.<a href="#section-9.1-3" class="pilcrow">¶</a></p>
<p id="section-9.1-4">Client-facing servers with non-uniform cryptographic configurations across backend
origin servers segment the ECH anonymity set based on these configurations. For example,
if a client-facing server hosts k backend origin servers, and exactly one of those
backend origin servers supports a different set of cryptographic algorithms than the
other (k - 1) servers, it may be possible to identify this single server based on
the contents of the ServerHello as this message is not encrypted.<a href="#section-9.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="middleboxes">
<section id="section-9.2">
        <h3 id="name-middleboxes">
<a href="#section-9.2" class="section-number selfRef">9.2. </a><a href="#name-middleboxes" class="section-name selfRef">Middleboxes</a>
        </h3>
<p id="section-9.2-1">A more serious problem is MITM proxies which do not support this
extension. <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>, Section 9.3 requires that
such proxies remove any extensions they do not understand. The handshake will
then present a certificate based on the public name, without eching the
"encrypted_client_hello" extension to the client.<a href="#section-9.2-1" class="pilcrow">¶</a></p>
<p id="section-9.2-2">Depending on whether the client is configured to accept the proxy's certificate
as authoritative for the public name, this may trigger the retry logic described
in <a href="#handle-server-response" class="xref">Section 7.3</a> or result in a connection failure. A proxy which
is not authoritative for the public name cannot forge a signal to disable ECH.<a href="#section-9.2-2" class="pilcrow">¶</a></p>
<p id="section-9.2-3">A non-conformant MITM proxy which instead forwards the ECH extension,
substituting its own KeyShare value, will result in
the client-facing server recognizing the key, but failing to decrypt
the SNI. This causes a hard failure. Clients SHOULD NOT attempt to repair the
connection in this case.<a href="#section-9.2-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-10">
      <h2 id="name-security-considerations">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<div id="cleartext-dns">
<section id="section-10.1">
        <h3 id="name-why-is-cleartext-dns-ok">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-why-is-cleartext-dns-ok" class="section-name selfRef">Why is cleartext DNS OK?</a>
        </h3>
<p id="section-10.1-1">In comparison to <span>[<a href="#I-D.kazuho-protected-sni" class="xref">I-D.kazuho-protected-sni</a>]</span>, wherein DNS Resource
Records are signed via a server private key, ECH records have no
authenticity or provenance information. This means that any attacker
which can inject DNS responses or poison DNS caches, which is a common
scenario in client access networks, can supply clients with fake
ECH records (so that the client encrypts data to them) or strip the
ECH record from the response. However, in the face of an attacker that
controls DNS, no encryption scheme can work because the attacker
can replace the IP address, thus blocking client connections, or
substituting a unique IP address which is 1:1 with the DNS name that
was looked up (modulo DNS wildcards). Thus, allowing the ECH records in
the clear does not make the situation significantly worse.<a href="#section-10.1-1" class="pilcrow">¶</a></p>
<p id="section-10.1-2">Clearly, DNSSEC (if the client validates and hard fails) is a defense against
this form of attack, but DoH/DPRIVE are also defenses against DNS attacks
by attackers on the local network, which is a common case where ClientHello and SNI
encryption are desired. Moreover, as noted in the introduction, SNI encryption is
less useful without encryption of DNS queries in transit via DoH or DPRIVE mechanisms.<a href="#section-10.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="client-tracking">
<section id="section-10.2">
        <h3 id="name-client-tracking">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-client-tracking" class="section-name selfRef">Client Tracking</a>
        </h3>
<p id="section-10.2-1">A malicious client-facing server could distribute unique, per-client ECHConfig
structures as a way of tracking clients across subsequent connections. On-path
adversaries which know about these unique keys could also track clients in this
way by observing TLS connection attempts.<a href="#section-10.2-1" class="pilcrow">¶</a></p>
<p id="section-10.2-2">The cost of this type of attack scales linearly with the desired number of target
clients. Moreover, DNS caching behavior makes targeting individual users for extended
periods of time, e.g., using per-client ECHConfig structures delivered via HTTPS
RRs with high TTLs, challenging. Clients can help mitigate this problem by
flushing any DNS or ECHConfig state upon changing networks.<a href="#section-10.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="optional-record-digests-and-trial-decryption">
<section id="section-10.3">
        <h3 id="name-optional-record-digests-and">
<a href="#section-10.3" class="section-number selfRef">10.3. </a><a href="#name-optional-record-digests-and" class="section-name selfRef">Optional Record Digests and Trial Decryption</a>
        </h3>
<p id="section-10.3-1">Optional record digests may be useful in scenarios where clients and client-facing
servers do not want to reveal information about the client-facing server in the
"encrypted_client_hello" extension. In such settings, clients send 
either an empty record_digest or a randomly generated record_digest
in the ClientEncryptedCH. (The precise implementation choice for this
mechanism is out of scope for this document.) Servers in these settings 
must perform trial decryption since they cannot identify the client's chosen 
ECH key using the record_digest value. As a result, support for optional 
record digests may exacerbate DoS attacks.
Specifically, an adversary may send malicious ClientHello messages, i.e., those
which will not decrypt with any known ECH key, in order to force wasteful decryption.
Servers that support this feature should, for example, implement some form of rate
limiting mechanism to limit the damage caused by such attacks.<a href="#section-10.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="related-privacy-leaks">
<section id="section-10.4">
        <h3 id="name-related-privacy-leaks">
<a href="#section-10.4" class="section-number selfRef">10.4. </a><a href="#name-related-privacy-leaks" class="section-name selfRef">Related Privacy Leaks</a>
        </h3>
<p id="section-10.4-1">ECH requires encrypted DNS to be an effective privacy protection mechanism.
However, verifying the server's identity from the Certificate message, particularly
when using the X509 CertificateType, may result in additional network traffic
that may reveal the server identity. Examples of this traffic may include requests
for revocation information, such as OCSP or CRL traffic, or requests for repository
information, such as authorityInformationAccess. It may also include
implementation-specific traffic for additional information sources as part of
verification.<a href="#section-10.4-1" class="pilcrow">¶</a></p>
<p id="section-10.4-2">Implementations SHOULD avoid leaking information that may identify the
server. Even when sent over an encrypted transport, such requests may result
in indirect exposure of the server's identity, such as indicating a specific CA
or service being used. To mitigate this risk, servers SHOULD deliver such
information in-band when possible, such as through the use of OCSP stapling,
and clients SHOULD take steps to minimize or protect such requests during
certificate validation.<a href="#section-10.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="comparison-against-criteria">
<section id="section-10.5">
        <h3 id="name-comparison-against-criteria">
<a href="#section-10.5" class="section-number selfRef">10.5. </a><a href="#name-comparison-against-criteria" class="section-name selfRef">Comparison Against Criteria</a>
        </h3>
<p id="section-10.5-1"><span>[<a href="#I-D.ietf-tls-sni-encryption" class="xref">I-D.ietf-tls-sni-encryption</a>]</span> lists several requirements for SNI
encryption. In this section, we re-iterate these requirements and assess
the ECH design against them.<a href="#section-10.5-1" class="pilcrow">¶</a></p>
<div id="mitigate-against-replay-attacks">
<section id="section-10.5.1">
          <h4 id="name-mitigate-against-replay-att">
<a href="#section-10.5.1" class="section-number selfRef">10.5.1. </a><a href="#name-mitigate-against-replay-att" class="section-name selfRef">Mitigate against replay attacks</a>
          </h4>
<p id="section-10.5.1-1">Since servers process either ClientHelloInner or ClientHelloOuter, and ClientHelloInner
contains an HPKE-derived nonce, it is not possible for an attacker to "cut and paste"
the ECH value in a different Client Hello and learn information from ClientHelloInner.
This is because the attacker lacks access to the HPKE-derived nonce used to derive the
handshake secrets.<a href="#section-10.5.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="avoid-widely-deployed-shared-secrets">
<section id="section-10.5.2">
          <h4 id="name-avoid-widely-deployed-share">
<a href="#section-10.5.2" class="section-number selfRef">10.5.2. </a><a href="#name-avoid-widely-deployed-share" class="section-name selfRef">Avoid widely-deployed shared secrets</a>
          </h4>
<p id="section-10.5.2-1">This design depends upon DNS as a vehicle for semi-static public key distribution.
Server operators may partition their private keys however they see fit provided
each server behind an IP address has the corresponding private key to decrypt
a key. Thus, when one ECH key is provided, sharing is optimally bound by the number
of hosts that share an IP address. Server operators may further limit sharing
by publishing different DNS records containing ECHConfig values with different
keys using a short TTL.<a href="#section-10.5.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="prevent-sni-based-dos-attacks">
<section id="section-10.5.3">
          <h4 id="name-prevent-sni-based-dos-attac">
<a href="#section-10.5.3" class="section-number selfRef">10.5.3. </a><a href="#name-prevent-sni-based-dos-attac" class="section-name selfRef">Prevent SNI-based DoS attacks</a>
          </h4>
<p id="section-10.5.3-1">This design requires servers to decrypt ClientHello messages with ClientEncryptedCH
extensions carrying valid digests. Thus, it is possible for an attacker to force
decryption operations on the server. This attack is bound by the number of
valid TCP connections an attacker can open.<a href="#section-10.5.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="do-not-stick-out">
<section id="section-10.5.4">
          <h4 id="name-do-not-stick-out">
<a href="#section-10.5.4" class="section-number selfRef">10.5.4. </a><a href="#name-do-not-stick-out" class="section-name selfRef">Do not stick out</a>
          </h4>
<p id="section-10.5.4-1">The only explicit signal indicating possible use of ECH is the ClientHello
"encrypted_client_hello" extension. Server handshake messages do not contain any
signal indicating use or negotiation of ECH. Clients MAY GREASE the
"encrypted_client_hello" extension, as described in <a href="#grease-extensions" class="xref">Section 7.4</a>, which
helps ensure the ecosystem handles ECH correctly. Moreover, as more clients
enable ECH support, e.g., as normal part of Web browser functionality, with keys
supplied by shared hosting providers, the presence of ECH extensions becomes less
unusual and part of typical client behavior. In other words, if all Web browsers
start using ECH, the presence of this value will not signal unusual behavior
to passive eavesdroppers.<a href="#section-10.5.4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="forward-secrecy">
<section id="section-10.5.5">
          <h4 id="name-forward-secrecy">
<a href="#section-10.5.5" class="section-number selfRef">10.5.5. </a><a href="#name-forward-secrecy" class="section-name selfRef">Forward secrecy</a>
          </h4>
<p id="section-10.5.5-1">This design is not forward secret because the server's ECH key is static.
However, the window of exposure is bound by the key lifetime. It is
RECOMMENDED that servers rotate keys frequently.<a href="#section-10.5.5-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="proper-security-context">
<section id="section-10.5.6">
          <h4 id="name-proper-security-context">
<a href="#section-10.5.6" class="section-number selfRef">10.5.6. </a><a href="#name-proper-security-context" class="section-name selfRef">Proper security context</a>
          </h4>
<p id="section-10.5.6-1">This design permits servers operating in Split Mode to forward connections
directly to backend origin servers, thereby avoiding unnecessary MiTM attacks.<a href="#section-10.5.6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="split-server-spoofing">
<section id="section-10.5.7">
          <h4 id="name-split-server-spoofing">
<a href="#section-10.5.7" class="section-number selfRef">10.5.7. </a><a href="#name-split-server-spoofing" class="section-name selfRef">Split server spoofing</a>
          </h4>
<p id="section-10.5.7-1">Assuming ECH records retrieved from DNS are authenticated, e.g., via DNSSEC or fetched
from a trusted Recursive Resolver, spoofing a server operating in Split Mode
is not possible. See <a href="#cleartext-dns" class="xref">Section 10.1</a> for more details regarding cleartext
DNS.<a href="#section-10.5.7-1" class="pilcrow">¶</a></p>
<p id="section-10.5.7-2">Authenticating the ECHConfigs structure naturally authenticates the
included public name. This also authenticates any retry signals
from the server because the client validates the server
certificate against the public name before retrying.<a href="#section-10.5.7-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="supporting-multiple-protocols">
<section id="section-10.5.8">
          <h4 id="name-supporting-multiple-protoco">
<a href="#section-10.5.8" class="section-number selfRef">10.5.8. </a><a href="#name-supporting-multiple-protoco" class="section-name selfRef">Supporting multiple protocols</a>
          </h4>
<p id="section-10.5.8-1">This design has no impact on application layer protocol negotiation. It may affect
connection routing, server certificate selection, and client certificate verification.
Thus, it is compatible with multiple protocols.<a href="#section-10.5.8-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="padding-policy">
<section id="section-10.6">
        <h3 id="name-padding-policy">
<a href="#section-10.6" class="section-number selfRef">10.6. </a><a href="#name-padding-policy" class="section-name selfRef">Padding Policy</a>
        </h3>
<p id="section-10.6-1">Variations in the length of the ClientHelloInner ciphertext could leak information
about the corresponding plaintext. <a href="#padding" class="xref">Section 7.2</a> describes a RECOMMENDED padding
mechanism for clients aimed at reducing potential information leakage.<a href="#section-10.6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="active-attack-mitigations">
<section id="section-10.7">
        <h3 id="name-active-attack-mitigations">
<a href="#section-10.7" class="section-number selfRef">10.7. </a><a href="#name-active-attack-mitigations" class="section-name selfRef">Active Attack Mitigations</a>
        </h3>
<p id="section-10.7-1">This section describes the rationale for ECH properties and mechanics as defenses
against active attacks. In all the attacks below, the attacker is on-path between
the target client and server. The goal of the attacker is to learn private information
about the inner ClientHello, such as the true SNI value.<a href="#section-10.7-1" class="pilcrow">¶</a></p>
<div id="flow-client-reaction">
<section id="section-10.7.1">
          <h4 id="name-client-reaction-attack-miti">
<a href="#section-10.7.1" class="section-number selfRef">10.7.1. </a><a href="#name-client-reaction-attack-miti" class="section-name selfRef">Client Reaction Attack Mitigation</a>
          </h4>
<p id="section-10.7.1-1">This attack uses the client's reaction to an incorrect certificate as an oracle.
The attacker intercepts a legitimate ClientHello and replies with a
ServerHello, Certificate, CertificateVerify, and Finished messages, wherein the Certificate
message contains a "test" certificate for the domain name it wishes to query. If the client
decrypted the Certificate and failed verification (or leaked information about its verification
process by a timing side channel), the attacker learns that its test certificate name
was incorrect. As an example, suppose the client's SNI value in its inner ClientHello is
"example.com," and the attacker replied with a Certificate for "test.com". If the client
produces a verification failure alert because of the mismatch faster than it would due to
the Certificate signature validation, information about the name leaks. Note that the
attacker can also withhold the CertificateVerify message. In that scenario, a client
which first verifies the Certificate would then respond similarly and leak the same
information.<a href="#section-10.7.1-1" class="pilcrow">¶</a></p>
<span id="name-client-reaction-attack"></span><div id="flow-diagram-client-reaction">
<figure id="figure-3">
            <div class="artwork art-text alignLeft" id="section-10.7.1-2.1">
<pre>
 Client                         Attacker                      Server
   ClientHello
   + key_share
   + ech         ------&gt;      (intercept)     -----&gt; X (drop)

                             ServerHello
                             + key_share
                   {EncryptedExtensions}
                   {CertificateRequest*}
                          {Certificate*}
                    {CertificateVerify*}
                 &lt;------
   Alert
                 ------&gt;
</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-client-reaction-attack" class="selfRef">Client reaction attack</a>
            </figcaption></figure>
</div>
<p id="section-10.7.1-3">The "ech_nonce" extension in the inner ClientHello prevents this attack. In particular,
since the attacker does not have access to this value, it cannot produce the right transcript
and handshake keys needed for encrypting the Certificate message. Thus, the client will fail
to decrypt the Certificate and abort the connection.<a href="#section-10.7.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="flow-hrr-hijack">
<section id="section-10.7.2">
          <h4 id="name-helloretryrequest-hijack-mi">
<a href="#section-10.7.2" class="section-number selfRef">10.7.2. </a><a href="#name-helloretryrequest-hijack-mi" class="section-name selfRef">HelloRetryRequest Hijack Mitigation</a>
          </h4>
<p id="section-10.7.2-1">This attack aims to exploit server HRR state management to recover information about
a legitimate ClientHello using its own attacker-controlled ClientHello.
To begin, the attacker intercepts and forwards a legitimate ClientHello with an
"encrypted_client_hello" (ech) extension to the server, which triggers a
legitimate HelloRetryRequest in return. Rather than forward the retry to the client,
the attacker, attempts to generate its own ClientHello in response based on the
contents of the first ClientHello and HelloRetryRequest exchange with the result
that the server encrypts the Certificate to the attacker. If the server
used the SNI from the first ClientHello and the key share from the second
(attacker-controlled) ClientHello, the Certificate produced would leak the
client's chosen SNI to the attacker.<a href="#section-10.7.2-1" class="pilcrow">¶</a></p>
<span id="name-helloretryrequest-hijack-at"></span><div id="flow-diagram-hrr-hijack">
<figure id="figure-4">
            <div class="artwork art-text alignLeft" id="section-10.7.2-2.1">
<pre>
 Client                         Attacker                      Server
   ClientHello
   + key_share
   + ech         ------&gt;       (forward)        -------&gt;
                                                   HelloRetryRequest
                                                         + key_share
                              (intercept)       &lt;-------

                              ClientHello
                              + key_share'
                              + ech'           -------&gt;
                                                         ServerHello
                                                         + key_share
                                               {EncryptedExtensions}
                                               {CertificateRequest*}
                                                      {Certificate*}
                                                {CertificateVerify*}
                                                          {Finished}
                                                &lt;-------
                         (process server flight)
</pre>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-helloretryrequest-hijack-at" class="selfRef">HelloRetryRequest hijack attack</a>
            </figcaption></figure>
</div>
<p id="section-10.7.2-3">This attack is mitigated by binding the first and second ClientHello messages together.
In particular, since the attacker does not possess the ech_hrr_key, it cannot
generate a valid encryption of the second inner ClientHello. The server will
attempt decryption using ech_hrr_key, detect failure, and fail the connection.<a href="#section-10.7.2-3" class="pilcrow">¶</a></p>
<p id="section-10.7.2-4">If the second ClientHello were not bound to the first, it might be possible
for the server to act as an oracle if it required parameters from the first
ClientHello to match that of the second ClientHello. For example, imagine
the client's original SNI value in the inner ClientHello is "example.com",
and the attacker's hijacked SNI value in its inner ClientHello is "test.com".
A server which checks these for equality and changes behavior based on the
result can be used as an oracle to learn the client's SNI.<a href="#section-10.7.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="flow-resumption-oracle">
<section id="section-10.7.3">
          <h4 id="name-resumption-psk-oracle-mitig">
<a href="#section-10.7.3" class="section-number selfRef">10.7.3. </a><a href="#name-resumption-psk-oracle-mitig" class="section-name selfRef">Resumption PSK Oracle Mitigation</a>
          </h4>
<p id="section-10.7.3-1">This attack uses resumption PSKs as an oracle for dictionary attacks against
a given ClientHello's true SNI. To begin, the attacker first interacts
with a server to obtain a resumption ticket for a given test domain, such
as "test.com". Later, upon receipt of a legitimate ClientHello without a PSK
binder, it computes a PSK binder using its own ticket and forwards the resulting
ClientHello. Assume the server then validates the PSK binder on the outer
ClientHello and chooses connection parameters based on the inner ClientHello.
A server which then validates information in the outer ClientHello ticket against
information in the inner ClientHello, such as the SNI, introduces an oracle that
can be used to test the encrypted SNI value of specific ClientHello messages.<a href="#section-10.7.3-1" class="pilcrow">¶</a></p>
<span id="name-message-flow-for-resumption"></span><div id="tls-resumption-psk">
<figure id="figure-5">
            <div class="artwork art-text alignLeft" id="section-10.7.3-2.1">
<pre>
       Client                    Attacker                    Server

                                        handshake and ticket
                                           for "test.com"
                                             &lt;--------&gt;

       ClientHello
       + key_share
       + ech        --------&gt;  (intercept)
                                  ClientHello
                                  + key_share
                                  + ech
                                  + pre_shared_key
                                             --------&gt;
                                                             Alert
                                             &lt;--------
</pre>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-message-flow-for-resumption" class="selfRef">Message flow for resumption and PSK</a>
            </figcaption></figure>
</div>
<p id="section-10.7.3-3">ECH mitigates against this attack by requiring servers not mix-and-match
information from the inner and outer ClientHello. For example, if the server
accepts the inner ClientHello, it does not validate binders in the outer
ClientHello. This means that ECH PSKs are used within the HPKE encryption
envelope.<a href="#section-10.7.3-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-11">
      <h2 id="name-iana-considerations">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<div id="update-of-the-tls-extensiontype-registry">
<section id="section-11.1">
        <h3 id="name-update-of-the-tls-extension">
<a href="#section-11.1" class="section-number selfRef">11.1. </a><a href="#name-update-of-the-tls-extension" class="section-name selfRef">Update of the TLS ExtensionType Registry</a>
        </h3>
<p id="section-11.1-1">IANA is requested to create the following two entries in the existing registry
for ExtensionType (defined in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>):<a href="#section-11.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-11.1-2">
          <li id="section-11.1-2.1">encrypted_client_hello(0xff02), with "TLS 1.3" column values being set to
"CH, EE", and "Recommended" column being set to "Yes".<a href="#section-11.1-2.1" class="pilcrow">¶</a>
</li>
<li id="section-11.1-2.2">ech_nonce(0xff03), with the "TLS 1.3" column values being set to
"CH", and "Recommended" column being set to "Yes".<a href="#section-11.1-2.2" class="pilcrow">¶</a>
</li>
<li id="section-11.1-2.3">outer_extension(0xff04), with the "TLS 1.3" column values being set to
"CH", and "Recommended" column being set to "Yes".<a href="#section-11.1-2.3" class="pilcrow">¶</a>
</li>
</ol>
</section>
</div>
<div id="update-of-the-tls-alert-registry">
<section id="section-11.2">
        <h3 id="name-update-of-the-tls-alert-reg">
<a href="#section-11.2" class="section-number selfRef">11.2. </a><a href="#name-update-of-the-tls-alert-reg" class="section-name selfRef">Update of the TLS Alert Registry</a>
        </h3>
<p id="section-11.2-1">IANA is requested to create an entry, ech_required(121) in the
existing registry for Alerts (defined in <span>[<a href="#RFC8446" class="xref">RFC8446</a>]</span>), with the
"DTLS-OK" column being set to "Y".<a href="#section-11.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="config-extensions">
<section id="section-12">
      <h2 id="name-echconfig-extension-guidanc">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-echconfig-extension-guidanc" class="section-name selfRef">ECHConfig Extension Guidance</a>
      </h2>
<p id="section-12-1">Any future information or hints that influence the outer ClientHello SHOULD be
specified as ECHConfig extensions, or in an entirely new version of ECHConfig.
This is primarily because the outer ClientHello exists only in support of ECH.
Namely, it is both an envelope for the encrypted inner ClientHello and enabler for
authenticated key mismatch signals (see <a href="#server-behavior" class="xref">Section 8</a>). In contrast, the inner
ClientHello is the true ClientHello used upon ECH negotiation.<a href="#section-12-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-13">
      <h2 id="name-references">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-13.1">
        <h3 id="name-normative-references">
<a href="#section-13.1" class="section-number selfRef">13.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="HTTPS-RR">[HTTPS-RR]</dt>
<dd>
<span class="refAuthor">Schwartz, B.</span><span class="refAuthor">, Bishop, M.</span><span class="refAuthor">, and E. Nygren</span>, <span class="refTitle">"Service binding and parameter specification via the DNS (DNS SVCB and HTTPS RRs)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-dnsop-svcb-https-00</span>, <time datetime="2020-06-12">12 June 2020</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-dnsop-svcb-https-00.txt">http://www.ietf.org/internet-drafts/draft-ietf-dnsop-svcb-https-00.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-tls-exported-authenticator">[I-D.ietf-tls-exported-authenticator]</dt>
<dd>
<span class="refAuthor">Sullivan, N.</span>, <span class="refTitle">"Exported Authenticators in TLS"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-tls-exported-authenticator-12</span>, <time datetime="2020-05-15">15 May 2020</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-tls-exported-authenticator-12.txt">http://www.ietf.org/internet-drafts/draft-ietf-tls-exported-authenticator-12.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.irtf-cfrg-hpke">[I-D.irtf-cfrg-hpke]</dt>
<dd>
<span class="refAuthor">Barnes, R.</span><span class="refAuthor">, Bhargavan, K.</span><span class="refAuthor">, and C. Wood</span>, <span class="refTitle">"Hybrid Public Key Encryption"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-irtf-cfrg-hpke-04</span>, <time datetime="2020-05-08">8 May 2020</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-irtf-cfrg-hpke-04.txt">http://www.ietf.org/internet-drafts/draft-irtf-cfrg-hpke-04.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
<dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7685">[RFC7685]</dt>
<dd>
<span class="refAuthor">Langley, A.</span>, <span class="refTitle">"A Transport Layer Security (TLS) ClientHello Padding Extension"</span>, <span class="seriesInfo">RFC 7685</span>, <span class="seriesInfo">DOI 10.17487/RFC7685</span>, <time datetime="2015-10">October 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7685">https://www.rfc-editor.org/info/rfc7685</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7918">[RFC7918]</dt>
<dd>
<span class="refAuthor">Langley, A.</span><span class="refAuthor">, Modadugu, N.</span><span class="refAuthor">, and B. Moeller</span>, <span class="refTitle">"Transport Layer Security (TLS) False Start"</span>, <span class="seriesInfo">RFC 7918</span>, <span class="seriesInfo">DOI 10.17487/RFC7918</span>, <time datetime="2016-08">August 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7918">https://www.rfc-editor.org/info/rfc7918</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7924">[RFC7924]</dt>
<dd>
<span class="refAuthor">Santesson, S.</span><span class="refAuthor"> and H. Tschofenig</span>, <span class="refTitle">"Transport Layer Security (TLS) Cached Information Extension"</span>, <span class="seriesInfo">RFC 7924</span>, <span class="seriesInfo">DOI 10.17487/RFC7924</span>, <time datetime="2016-07">July 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7924">https://www.rfc-editor.org/info/rfc7924</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
<dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8446">[RFC8446]</dt>
<dd>
<span class="refAuthor">Rescorla, E.</span>, <span class="refTitle">"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span class="seriesInfo">RFC 8446</span>, <span class="seriesInfo">DOI 10.17487/RFC8446</span>, <time datetime="2018-08">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8446">https://www.rfc-editor.org/info/rfc8446</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-13.2">
        <h3 id="name-informative-references">
<a href="#section-13.2" class="section-number selfRef">13.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="I-D.ietf-doh-dns-over-https">[I-D.ietf-doh-dns-over-https]</dt>
<dd>
<span class="refAuthor">Hoffman, P.</span><span class="refAuthor"> and P. McManus</span>, <span class="refTitle">"DNS Queries over HTTPS (DoH)"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-doh-dns-over-https-14</span>, <time datetime="2018-08-16">16 August 2018</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-doh-dns-over-https-14.txt">http://www.ietf.org/internet-drafts/draft-ietf-doh-dns-over-https-14.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ietf-tls-sni-encryption">[I-D.ietf-tls-sni-encryption]</dt>
<dd>
<span class="refAuthor">Huitema, C.</span><span class="refAuthor"> and E. Rescorla</span>, <span class="refTitle">"Issues and Requirements for SNI Encryption in TLS"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-tls-sni-encryption-09</span>, <time datetime="2019-10-28">28 October 2019</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-tls-sni-encryption-09.txt">http://www.ietf.org/internet-drafts/draft-ietf-tls-sni-encryption-09.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.kazuho-protected-sni">[I-D.kazuho-protected-sni]</dt>
<dd>
<span class="refAuthor">Oku, K.</span>, <span class="refTitle">"TLS Extensions for Protecting SNI"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-kazuho-protected-sni-00</span>, <time datetime="2017-07-18">18 July 2017</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-kazuho-protected-sni-00.txt">http://www.ietf.org/internet-drafts/draft-kazuho-protected-sni-00.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7301">[RFC7301]</dt>
<dd>
<span class="refAuthor">Friedl, S.</span><span class="refAuthor">, Popov, A.</span><span class="refAuthor">, Langley, A.</span><span class="refAuthor">, and E. Stephan</span>, <span class="refTitle">"Transport Layer Security (TLS) Application-Layer Protocol Negotiation Extension"</span>, <span class="seriesInfo">RFC 7301</span>, <span class="seriesInfo">DOI 10.17487/RFC7301</span>, <time datetime="2014-07">July 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7301">https://www.rfc-editor.org/info/rfc7301</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7858">[RFC7858]</dt>
<dd>
<span class="refAuthor">Hu, Z.</span><span class="refAuthor">, Zhu, L.</span><span class="refAuthor">, Heidemann, J.</span><span class="refAuthor">, Mankin, A.</span><span class="refAuthor">, Wessels, D.</span><span class="refAuthor">, and P. Hoffman</span>, <span class="refTitle">"Specification for DNS over Transport Layer Security (TLS)"</span>, <span class="seriesInfo">RFC 7858</span>, <span class="seriesInfo">DOI 10.17487/RFC7858</span>, <time datetime="2016-05">May 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7858">https://www.rfc-editor.org/info/rfc7858</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8094">[RFC8094]</dt>
<dd>
<span class="refAuthor">Reddy, T.</span><span class="refAuthor">, Wing, D.</span><span class="refAuthor">, and P. Patil</span>, <span class="refTitle">"DNS over Datagram Transport Layer Security (DTLS)"</span>, <span class="seriesInfo">RFC 8094</span>, <span class="seriesInfo">DOI 10.17487/RFC8094</span>, <time datetime="2017-02">February 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8094">https://www.rfc-editor.org/info/rfc8094</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8701">[RFC8701]</dt>
<dd>
<span class="refAuthor">Benjamin, D.</span>, <span class="refTitle">"Applying Generate Random Extensions And Sustain Extensibility (GREASE) to TLS Extensibility"</span>, <span class="seriesInfo">RFC 8701</span>, <span class="seriesInfo">DOI 10.17487/RFC8701</span>, <time datetime="2020-01">January 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8701">https://www.rfc-editor.org/info/rfc8701</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="alternative-sni-protection-designs">
<section id="section-appendix.a">
      <h2 id="name-alternative-sni-protection-">
<a href="#section-appendix.a" class="section-number selfRef">Appendix A. </a><a href="#name-alternative-sni-protection-" class="section-name selfRef">Alternative SNI Protection Designs</a>
      </h2>
<p id="section-appendix.a-1">Alternative approaches to encrypted SNI may be implemented at the TLS or
application layer. In this section we describe several alternatives and discuss
drawbacks in comparison to the design in this document.<a href="#section-appendix.a-1" class="pilcrow">¶</a></p>
<div id="tls-layer">
<section id="section-a.1">
        <h2 id="name-tls-layer">
<a href="#section-a.1" class="section-number selfRef">A.1. </a><a href="#name-tls-layer" class="section-name selfRef">TLS-layer</a>
        </h2>
<div id="tls-in-early-data">
<section id="section-a.1.1">
          <h3 id="name-tls-in-early-data">
<a href="#section-a.1.1" class="section-number selfRef">A.1.1. </a><a href="#name-tls-in-early-data" class="section-name selfRef">TLS in Early Data</a>
          </h3>
<p id="section-a.1.1-1">In this variant, TLS Client Hellos are tunneled within early data payloads
belonging to outer TLS connections established with the client-facing server. This
requires clients to have established a previous session --- and obtained PSKs --- with
the server. The client-facing server decrypts early data payloads to uncover Client Hellos
destined for the backend server, and forwards them onwards as necessary. Afterwards, all
records to and from backend servers are forwarded by the client-facing server - unmodified.
This avoids double encryption of TLS records.<a href="#section-a.1.1-1" class="pilcrow">¶</a></p>
<p id="section-a.1.1-2">Problems with this approach are: (1) servers may not always be able to
distinguish inner Client Hellos from legitimate application data, (2) nested 0-RTT
data may not function correctly, (3) 0-RTT data may not be supported -
especially under DoS - leading to availability concerns, and (4) clients must bootstrap
tunnels (sessions), costing an additional round trip and potentially revealing the SNI
during the initial connection. In contrast, encrypted SNI protects the SNI in a distinct
Client Hello extension and neither abuses early data nor requires a bootstrapping connection.<a href="#section-a.1.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="combined-tickets">
<section id="section-a.1.2">
          <h3 id="name-combined-tickets">
<a href="#section-a.1.2" class="section-number selfRef">A.1.2. </a><a href="#name-combined-tickets" class="section-name selfRef">Combined Tickets</a>
          </h3>
<p id="section-a.1.2-1">In this variant, client-facing and backend servers coordinate to produce "combined tickets"
that are consumable by both. Clients offer combined tickets to client-facing servers.
The latter parse them to determine the correct backend server to which the Client Hello
should be forwarded. This approach is problematic due to non-trivial coordination between
client-facing and backend servers for ticket construction and consumption. Moreover,
it requires a bootstrapping step similar to that of the previous variant. In contrast,
encrypted SNI requires no such coordination.<a href="#section-a.1.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="application-layer">
<section id="section-a.2">
        <h2 id="name-application-layer">
<a href="#section-a.2" class="section-number selfRef">A.2. </a><a href="#name-application-layer" class="section-name selfRef">Application-layer</a>
        </h2>
<div id="http2-certificate-frames">
<section id="section-a.2.1">
          <h3 id="name-http-2-certificate-frames">
<a href="#section-a.2.1" class="section-number selfRef">A.2.1. </a><a href="#name-http-2-certificate-frames" class="section-name selfRef">HTTP/2 CERTIFICATE Frames</a>
          </h3>
<p id="section-a.2.1-1">In this variant, clients request secondary certificates with CERTIFICATE_REQUEST HTTP/2
frames after TLS connection completion. In response, servers supply certificates via TLS
exported authenticators <span>[<a href="#I-D.ietf-tls-exported-authenticator" class="xref">I-D.ietf-tls-exported-authenticator</a>]</span> in CERTIFICATE frames.
Clients use a generic SNI for the underlying client-facing server TLS connection.
Problems with this approach include: (1) one additional round trip before peer
authentication, (2) non-trivial application-layer dependencies and interaction,
and (3) obtaining the generic SNI to bootstrap the connection. In contrast, encrypted
SNI induces no additional round trip and operates below the application layer.<a href="#section-a.2.1-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="total-client-hello-encryption">
<section id="section-appendix.b">
      <h2 id="name-total-client-hello-encrypti">
<a href="#section-appendix.b" class="section-number selfRef">Appendix B. </a><a href="#name-total-client-hello-encrypti" class="section-name selfRef">Total Client Hello Encryption</a>
      </h2>
<p id="section-appendix.b-1">The design described here only provides encryption for the SNI, but
not for other extensions, such as ALPN. Another potential design
would be to encrypt all of the extensions using the same basic
structure as we use here for ECH. That design has the following
advantages:<a href="#section-appendix.b-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-appendix.b-2.1">It protects all the extensions from ordinary eavesdroppers<a href="#section-appendix.b-2.1" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-appendix.b-2.2">If the encrypted block has its own KeyShare, it does not
necessarily require the client to use a single KeyShare,
because the client's share is bound to the SNI by the
AEAD (analysis needed).<a href="#section-appendix.b-2.2" class="pilcrow">¶</a>
</li>
</ul>
<p id="section-appendix.b-3">It also has the following disadvantages:<a href="#section-appendix.b-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-appendix.b-4.1">The client-facing server can still see the other extensions. By
contrast we could introduce another EncryptedExtensions
block that was encrypted to the backend server and not
the client-facing server.<a href="#section-appendix.b-4.1" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-appendix.b-4.2">It requires a mechanism for the client-facing server to provide the
extension-encryption key to the backend server and thus cannot be
used with an unmodified backend server.<a href="#section-appendix.b-4.2" class="pilcrow">¶</a>
</li>
<li class="normal" id="section-appendix.b-4.3">A conforming middlebox will strip every extension, which might
result in a ClientHello which is just unacceptable to the server
(more analysis needed).<a href="#section-appendix.b-4.3" class="pilcrow">¶</a>
</li>
</ul>
</section>
</div>
<div id="acknowledgements">
<section id="section-appendix.c">
      <h2 id="name-acknowledgements">
<a href="#section-appendix.c" class="section-number selfRef">Appendix C. </a><a href="#name-acknowledgements" class="section-name selfRef">Acknowledgements</a>
      </h2>
<p id="section-appendix.c-1">This document draws extensively from ideas in <span>[<a href="#I-D.kazuho-protected-sni" class="xref">I-D.kazuho-protected-sni</a>]</span>, but
is a much more limited mechanism because it depends on the DNS for the
protection of the ECH key. Richard Barnes, Christian Huitema, Patrick McManus,
Matthew Prince, Nick Sullivan, Martin Thomson, and David Benjamin also provided
important ideas and contributions.<a href="#section-appendix.c-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="section-appendix.d">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Eric Rescorla</span></div>
<div dir="auto" class="left"><span class="org">RTFM, Inc.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ekr@rtfm.com" class="email">ekr@rtfm.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Kazuho Oku</span></div>
<div dir="auto" class="left"><span class="org">Fastly</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:kazuhooku@gmail.com" class="email">kazuhooku@gmail.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Nick Sullivan</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:nick@cloudflare.com" class="email">nick@cloudflare.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christopher A. Wood</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:caw@heapingbits.net" class="email">caw@heapingbits.net</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
